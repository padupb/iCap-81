# Documentação Completa do Sistema i-CAP 5.0

## Visão Geral do Projeto
O i-CAP 5.0 é um sistema de gerenciamento logístico para suprimentos de construção rodoviária, desenvolvido usando React, Vite, Tailwind CSS e PostgreSQL. O sistema possui múltiplos módulos especializados com interface em português e tema escuro.

## Características Principais
- Sistema completo de controle de usuários e permissões granulares
- Gestão de empresas fornecedoras e categorias
- Gestão de produtos e unidades de medida
- Sistema de ordens (pedidos) com aprovação
- Sistema de ordens de compra com vínculo a contratos
- Vinculação de ordens de compra a obras específicas
- Dashboard com indicadores e alertas
- Logs de sistema para auditoria
- Configurações gerais do sistema

## Tecnologias Utilizadas
- Frontend: React, TypeScript, Vite, Tailwind CSS, Shadcn/UI
- Backend: Node.js, Express, TypeScript
- Banco de Dados: PostgreSQL
- ORM: Drizzle
- Validação: Zod
- Autenticação: Express Session com PostgreSQL
- Gerenciamento de Estado: TanStack React Query

## Estrutura de Pastas
```
├── client/
│   ├── src/
│   │   ├── components/
│   │   ├── context/
│   │   ├── hooks/
│   │   ├── lib/
│   │   ├── pages/
│   │   ├── main.tsx
│   │   ├── App.tsx
│   │   └── index.css
├── server/
│   ├── db.ts
│   ├── index.ts
│   ├── routes.ts
│   ├── storage.ts
│   ├── types.ts
│   └── vite.ts
├── shared/
│   └── schema.ts
```

## Atualizações Recentes

### Vinculação de Pedidos a Ordens de Compra
1. **Campo Ordem de Compra no formulário de pedidos**: Adicionado campo de seleção que permite associar um pedido a uma ordem de compra ativa.
2. **Filtragem inteligente**: O sistema filtra automaticamente e exibe apenas ordens de compra que:
   - Têm status "Ativo"
   - Possuem validade atual (não expiradas)
   - Pertencem à empresa do usuário logado que está realizando o pedido
3. **Validação de status**: Sistema atualiza automaticamente o status das ordens de compra para "Expirado" quando a data de validade é ultrapassada.
4. **Restrição de status**: Ordens de compra só podem ter status "Ativo" ou "Expirado", com cores diferenciadas (verde para Ativo, vermelho para Expirado).

## Detalhes de Design

### Cores (Padrão Dark Theme)
- Fundo Principal: #26262c
- Fundo Secundário: #1e1e24
- Fundo de Cartões: #1a1a1f
- Fundo de Inputs: #313139
- Botões Primários: #26262ccc
- Texto Principal: #ffffff
- Texto Secundário: #a1a1aa
- Bordas: #3f3f45
- Destaque: #3f8cff
- Sucesso: #22c55e
- Perigo: #ef4444
- Alerta: #f59e0b

### Espaçamentos
- Espaçamento base: 4px
- Espaçamento interno padrão: 12px (conforme requisito)
- Margem entre elementos: 12px
- Padding de cartões: 16px
- Gap entre colunas no grid: 16px
- Gap entre linhas no grid: 24px

### Fontes
- Família: Inter, sans-serif
- Tamanhos:
  - xs: 0.75rem
  - sm: 0.875rem
  - base: 1rem
  - lg: 1.125rem
  - xl: 1.25rem
  - 2xl: 1.5rem
  - 3xl: 1.875rem

### Ícones
- Biblioteca: Lucide React
- Tamanhos:
  - Pequeno: 16px
  - Médio: 20px
  - Grande: 24px

### Componentes UI
- Botões: variantes primary, secondary, outline, destructive
- Cards: com header, title, content
- Inputs: text, number, date, select
- Tables: com header, body, row, cell
- Dialogs: para modais e confirmações
- Forms: com labels, inputs, validation
- Toasts: para notificações
- Badges: para status e tags

## Estrutura do Banco de Dados

### Tabela `users`
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL UNIQUE,
  phone VARCHAR(20),
  password VARCHAR(255) NOT NULL,
  company_id INTEGER REFERENCES companies(id),
  role_id INTEGER REFERENCES user_roles(id),
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Tabela `companies`
```sql
CREATE TABLE companies (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  cnpj VARCHAR(20) NOT NULL,
  address TEXT,
  category_id INTEGER REFERENCES company_categories(id),
  approver_id INTEGER REFERENCES users(id),
  contract_number VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Tabela `company_categories`
```sql
CREATE TABLE company_categories (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  requires_approver BOOLEAN DEFAULT FALSE,
  receives_purchase_orders BOOLEAN DEFAULT FALSE,
  requires_contract BOOLEAN DEFAULT FALSE
);
```

### Tabela `user_roles`
```sql
CREATE TABLE user_roles (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  category_id INTEGER REFERENCES company_categories(id),
  permissions TEXT[]
);
```

### Tabela `products`
```sql
CREATE TABLE products (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  unit_id INTEGER REFERENCES units(id),
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Tabela `units`
```sql
CREATE TABLE units (
  id SERIAL PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  abbreviation VARCHAR(10) NOT NULL
);
```

### Tabela `orders`
```sql
CREATE TABLE orders (
  id SERIAL PRIMARY KEY,
  created_at TIMESTAMP DEFAULT NOW(),
  status VARCHAR(50) NOT NULL DEFAULT 'Pendente',
  order_id VARCHAR(50) NOT NULL,
  product_id INTEGER REFERENCES products(id),
  quantity VARCHAR(50) NOT NULL,
  supplier_id INTEGER REFERENCES companies(id),
  work_location VARCHAR(255),
  delivery_date DATE NOT NULL,
  is_urgent BOOLEAN DEFAULT FALSE,
  user_id INTEGER REFERENCES users(id),
  purchase_order_id INTEGER REFERENCES ordens_compra(id)
);
```

### Tabela `ordens_compra`
```sql
CREATE TABLE ordens_compra (
  id SERIAL PRIMARY KEY,
  numero_ordem TEXT NOT NULL,
  empresa_id INTEGER NOT NULL,
  obra_id INTEGER,
  usuario_id INTEGER NOT NULL,
  valido_ate TIMESTAMP WITHOUT TIME ZONE NOT NULL,
  status TEXT NOT NULL DEFAULT 'Ativo',
  valor_total NUMERIC(10,2) DEFAULT 0,
  data_criacao TIMESTAMP DEFAULT NOW()
);
```

### Tabela `itens_ordem_compra`
```sql
CREATE TABLE itens_ordem_compra (
  id SERIAL PRIMARY KEY,
  ordem_compra_id INTEGER REFERENCES ordens_compra(id),
  produto_id INTEGER REFERENCES products(id),
  quantidade VARCHAR(50) NOT NULL
);
```

### Tabela `obras`
```sql
CREATE TABLE obras (
  id SERIAL PRIMARY KEY,
  nome VARCHAR(255) NOT NULL,
  endereco TEXT,
  empresa_id INTEGER REFERENCES companies(id),
  data_criacao TIMESTAMP DEFAULT NOW()
);
```

### Tabela `system_logs`
```sql
CREATE TABLE system_logs (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL,
  action VARCHAR(255) NOT NULL,
  item_type VARCHAR(50) NOT NULL,
  item_id VARCHAR(255),
  details TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Tabela `settings`
```sql
CREATE TABLE settings (
  id SERIAL PRIMARY KEY,
  key VARCHAR(255) NOT NULL UNIQUE,
  value TEXT NOT NULL,
  description TEXT
);
```

## Dados Iniciais

### Usuário Administrador (KeyUser)
```sql
INSERT INTO users (name, email, password, role_id)
VALUES ('Desenvolvedor', 'padupb@admin.icap', 'senha_hash', 1);
```

### Categorias de Empresas
```sql
INSERT INTO company_categories (name, requires_approver, receives_purchase_orders, requires_contract)
VALUES
('Fornecedor', false, true, true),
('Cliente', true, false, false),
('Subcontratado', true, false, true),
('Parceiro', false, false, false);
```

### Perfis de Usuários
```sql
INSERT INTO user_roles (name, category_id, permissions)
VALUES
('Administrador', null, '{dev.ver,dev.editar,dev.cadastrar,dashboard.ver,usuarios.ver,usuarios.editar,usuarios.cadastrar,empresas.ver,empresas.editar,empresas.cadastrar,produtos.ver,produtos.editar,produtos.cadastrar,ordens.ver,ordens.editar,ordens.cadastrar,aprovacoes.ver,aprovacoes.editar,compras.ver,compras.editar,compras.cadastrar,configuracoes.ver,configuracoes.editar,logs.ver}'),
('Gerente', 1, '{dashboard.ver,usuarios.ver,empresas.ver,empresas.editar,produtos.ver,ordens.ver,ordens.editar,ordens.cadastrar,aprovacoes.ver,aprovacoes.editar,compras.ver,compras.editar,compras.cadastrar,logs.ver}'),
('Comprador', 1, '{dashboard.ver,empresas.ver,produtos.ver,ordens.ver,ordens.editar,ordens.cadastrar,compras.ver,compras.editar,compras.cadastrar}'),
('Aprovador', 2, '{dashboard.ver,empresas.ver,produtos.ver,ordens.ver,aprovacoes.ver,aprovacoes.editar}');
```

### Unidades de Medida
```sql
INSERT INTO units (name, abbreviation)
VALUES
('Tonelada', 't'),
('Quilograma', 'kg'),
('Metro', 'm'),
('Metro Quadrado', 'm²'),
('Metro Cúbico', 'm³'),
('Litro', 'l'),
('Unidade', 'un'),
('Peça', 'pç'),
('Caixa', 'cx'),
('Hora', 'h'),
('Dia', 'd'),
('Mês', 'mês'),
('Ano', 'ano');
```

### Empresas (Fornecedores)
```sql
INSERT INTO companies (name, cnpj, address, category_id, contract_number)
VALUES
('Nova Rota do Oeste', '12.345.678/0001-01', 'Av. Principal, 123 - São Paulo/SP', 1, 'CONT-2023-001'),
('Betunel', '23.456.789/0001-02', 'Rua Secundária, 456 - Rio de Janeiro/RJ', 1, 'CONT-2023-002'),
('CONSORCIO RODOVIA DOS IMIGRANTES', '34.567.890/0001-03', 'Rodovia dos Imigrantes, km 10 - Santos/SP', 1, 'CONT-2023-003');
```

### Obras
```sql
INSERT INTO obras (nome, endereco, empresa_id)
VALUES 
('Duplicação BR-101', 'BR-101, km 123-145, Paraíba', 11),
('Pavimentação Urbana', 'Centro de João Pessoa, diversas ruas', 12),
('Construção Viaduto', 'Entroncamento BR-230 com BR-101', 11),
('Recuperação Asfalto', 'Rodovia PB-008, Litoral Sul', 13);
```

### Produtos
```sql
INSERT INTO products (name, unit_id)
VALUES
('Cimento Asfaltico de Petroleo - CAP 50/70', 1),
('Asfalto Diluído CM-30', 1),
('Emulsão Asfáltica RR-1C', 1),
('Emulsão Asfáltica RR-2C', 1),
('Brita 0', 1),
('Brita 1', 1),
('Brita 2', 1),
('Areia Lavada', 1),
('Cimento Portland CP-II', 1),
('Vergalhão CA-50 10mm', 3),
('Vergalhão CA-50 12.5mm', 3),
('Forma Metálica', 4),
('Tubo de Concreto DN 600mm', 7),
('Tubo de Concreto DN 800mm', 7),
('Tubo de Concreto DN 1000mm', 7);
```

## Regras de Negócio

### Regras de Autenticação
1. Sistema verifica se o domínio do email é "@admin.icap" para identificar keyuser
2. Apenas keyuser tem acesso à página Dev

### Regras de Permissões
1. Permissões são granulares em 3 níveis por módulo:
   - Ver (visualização)
   - Editar (alteração)
   - Cadastrar (inclusão)
2. Módulos sem permissão não aparecem no menu lateral
3. Telas verificam permissões antes de exibir ações disponíveis

### Regras de Ordens de Compra
1. Ordens de compra devem estar vinculadas a um fornecedor e uma obra específica
2. Apenas empresas com número de contrato podem ser selecionadas
3. O formato de exibição das empresas deve ser "Nome da Empresa - Número do Contrato"
4. Se nenhuma empresa com contrato estiver disponível, o sistema deve exibir um aviso
5. Ordens com datas expiradas mostram automaticamente status "Expirado"
6. Ordem gera um ID automático no formato SIGLADATAHORA

### Regras de Ordens (Pedidos)
1. Ordens com prazo de entrega menor que 7 dias são marcadas como urgentes
2. Ordens urgentes precisam de aprovação especial
3. Aprovadores só podem ver/aprovar ordens vinculadas à sua empresa
4. Pedidos devem estar vinculados a uma ordem de compra ativa
5. No formulário de pedido, apenas ordens de compra ativas, válidas e da empresa do usuário são exibidas
6. Campo de ordem de compra filtra automaticamente por empresa do usuário logado

## Estrutura do Frontend

### Componentes Principais
- Header: barra superior com logo, nome do usuário e ações gerais
- Sidebar: menu lateral com navegação principal
- AuthContext: gerenciamento de autenticação
- AuthorizationContext: gerenciamento de permissões
- Layout: estrutura base das páginas com header e sidebar

### Páginas Principais
- Login: autenticação do usuário
- Dashboard: visão geral do sistema
- Users: gestão de usuários
- Companies: gestão de empresas
- Products: gestão de produtos
- Orders: gestão de ordens/pedidos
- Approvals: aprovação de ordens urgentes
- PurchaseOrders: gestão de ordens de compra
- Settings: configurações do sistema
- Logs: visualização de logs de auditoria
- Dev: página de desenvolvimento (apenas keyuser)

## Estrutura do Backend

### Rotas da API
- `/api/auth/*`: autenticação (login, logout, me)
- `/api/users`: CRUD de usuários
- `/api/companies`: CRUD de empresas
- `/api/company-categories`: CRUD de categorias de empresas
- `/api/user-roles`: CRUD de perfis de usuários
- `/api/products`: CRUD de produtos
- `/api/units`: CRUD de unidades de medida
- `/api/orders`: CRUD de ordens/pedidos
- `/api/ordem-compra-nova`: criação de ordens de compra (formato frontend)
- `/api/ordem-compra`: manipulação de ordens de compra (formato backend)
- `/api/ordens-compra`: listagem de ordens de compra
- `/api/obras`: listagem de obras
- `/api/settings`: configurações do sistema
- `/api/logs`: logs de sistema

### Middlewares
- Autenticação: verifica sessão do usuário
- Autorização: verifica permissões por rota
- Validação: valida dados de entrada com Zod

## Formulários e Validações

### Login
```typescript
const loginSchema = z.object({
  email: z.string().email("Email inválido"),
  password: z.string().min(1, "Senha é obrigatória")
});
```

### Usuário
```typescript
const userSchema = z.object({
  name: z.string().min(3, "Nome deve ter pelo menos 3 caracteres"),
  email: z.string().email("Email inválido"),
  phone: z.string().optional(),
  password: z.string().min(6, "Senha deve ter pelo menos 6 caracteres"),
  companyId: z.number().optional(),
  roleId: z.number().optional()
});
```

### Empresa
```typescript
const companySchema = z.object({
  name: z.string().min(3, "Nome deve ter pelo menos 3 caracteres"),
  cnpj: z.string().min(14, "CNPJ inválido").max(18),
  address: z.string().optional(),
  categoryId: z.number(),
  approverId: z.number().optional(),
  contractNumber: z.string().optional()
});
```

### Ordem de Compra
```typescript
const purchaseOrderFormSchema = z.object({
  orderNumber: z.string().min(5, "Número da ordem deve ter 5 dígitos").max(5)
    .regex(/^\d+$/, "Número da ordem deve conter apenas dígitos"),
  companyId: z.number().min(1, "Fornecedor é obrigatório"),
  obraId: z.number().min(1, "Obra é obrigatória"),
  validUntil: z.string().min(1, "Data de validade é obrigatória"),
  items: z.array(z.object({
    productId: z.number().min(1, "Produto é obrigatório"),
    quantity: z.string().min(1, "Quantidade é obrigatória"),
  })).min(1, "Pelo menos um produto é obrigatório").max(4, "Máximo 4 produtos por ordem"),
});

// Schema para pedidos com vínculo a ordem de compra
const orderFormSchema = insertOrderSchema.extend({
  deliveryDate: z.string().min(1, "Data de entrega é obrigatória"),
  purchaseOrderId: z.number().optional(),
});
```

## Implementações Específicas

### Autorização Granular
```typescript
// Verificação de permissão no AuthorizationContext
const hasPermission = (module: string, action: 'ver' | 'editar' | 'cadastrar') => {
  if (!user || !permissions) return false;
  const permissionKey = `${module}.${action}`;
  return permissions.includes(permissionKey);
};
```

### Geração de ID de Ordem
```typescript
// Geração de ID no formato SIGLADATAHORA
const generateOrderId = () => {
  const now = new Date();
  const year = now.getFullYear().toString().slice(2);
  const month = (now.getMonth() + 1).toString().padStart(2, '0');
  const day = now.getDate().toString().padStart(2, '0');
  const hour = now.getHours().toString().padStart(2, '0');
  const minute = now.getMinutes().toString().padStart(2, '0');
  const second = now.getSeconds().toString().padStart(2, '0');
  return `ICAP${year}${month}${day}${hour}${minute}${second}`;
};
```

### Criação de Ordem de Compra com Obra
```typescript
// Endpoint para criar ordem de compra com vínculo a obra
app.post("/api/ordem-compra-nova", async (req, res) => {
  try {
    // Verificar dados necessários
    if (!req.body.numero || !req.body.empresa || !req.body.obra || !req.body.validade || !req.body.produtos) {
      return res.status(400).json({
        sucesso: false,
        mensagem: "Dados incompletos. Número, fornecedor, obra, validade e produtos são obrigatórios"
      });
    }

    // Obter ID do usuário logado
    const userId = req.session.userId || 1;

    // Usar SQL nativo para inserir na tabela
    const { pool } = await import("./db");
    
    // Inserir a ordem de compra
    const result = await pool.query(
      `INSERT INTO ordens_compra 
       (numero_ordem, empresa_id, obra_id, usuario_id, valido_ate, status) 
       VALUES ($1, $2, $3, $4, $5, $6)
       RETURNING id, numero_ordem, empresa_id, obra_id, usuario_id, valido_ate, data_criacao, status`,
      [
        req.body.numero,
        req.body.empresa,
        req.body.obra,
        userId,
        req.body.validade,
        "Pendente"
      ]
    );
    
    // ... resto da implementação
  } catch (error) {
    // ... tratamento de erro
  }
});
```

## Implementação da Interface Gráfica

### Layout Geral
- Interface em tema escuro
- Margens internas padronizadas em 12px
- Navegação por sidebar com ícones e texto
- Disposição em cartões com sombras sutis

### Menu Lateral
- Logo e nome do sistema no topo
- Itens de menu com ícones à esquerda
- Destaque visual para item selecionado
- Visibilidade controlada por permissões

### Formulários
- Campos agrupados por seções
- Validação visual com mensagens de erro
- Botões de ação no rodapé dos formulários
- Select com opções de pesquisa para listas longas

### Tabelas
- Cabeçalhos com opção de ordenação
- Paginação para listas longas
- Ações na última coluna (ver, editar, excluir)
- Badges para indicar status

### Notificações
- Toasts para feedback de operações
- Mensagens de erro em vermelho
- Mensagens de sucesso em verde
- Tempo de exibição de 5 segundos

## Considerações de Implementação

### Verificações de Segurança
- Sempre validar dados de entrada no backend
- Verificar permissões antes de qualquer operação
- Sanitizar dados antes de inserir no banco
- Usar prepared statements para consultas SQL

### Otimizações de Performance
- Usar React Query para cache de dados
- Paginar resultados de consultas grandes
- Indexar colunas frequentemente consultadas
- Usar memoização para componentes pesados

### Extensibilidade
- Código modular e reutilizável
- Componentes desacoplados
- Tipos bem definidos
- Centralização de lógica de negócios

Este documento representa o estado atual do sistema i-CAP 5.0 com todos os detalhes necessários para sua reconstrução exata em caso de perda de dados.